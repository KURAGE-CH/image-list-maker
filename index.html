<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画像一覧メーカー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    .controls {
      margin-bottom: 20px;
    }

    #image-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, 120px);
      gap: 10px;
    }

    .item {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
      background: #f9f9f9;
    }

    .item img {
      width: 100%;
      height: 100px;
      object-fit: cover;
    }

    .buttons button {
      margin: 2px;
    }

    canvas {
      margin-top: 30px;
      border: 1px solid #ccc;
      max-width: 100%;
    }
  </style>
</head>
<body>

<h1>画像一覧メーカー</h1>

<div class="controls">
  <input type="file" id="files" multiple accept="image/*">
  <br><br>
  横の枚数：
  <input type="number" id="cols" value="5" min="1">
  <button id="generate">一覧画像を生成</button>
</div>

<div id="image-list"></div>

<canvas id="canvas"></canvas>

<script>
const filesInput = document.getElementById("files");
const list = document.getElementById("image-list");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const colsInput = document.getElementById("cols");
const generateBtn = document.getElementById("generate");

const SIZE = 200;
const GAP = 10;

let images = [];

filesInput.onchange = () => {
  for (const file of filesInput.files) {
    images.push({
      url: URL.createObjectURL(file)
    });
  }
  renderList();
  filesInput.value = "";
};

function renderList() {
  list.innerHTML = "";
  images.forEach((img, i) => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <img src="${img.url}">
      <div class="buttons">
        <button data-act="up" data-i="${i}">↑</button>
        <button data-act="down" data-i="${i}">↓</button>
        <button data-act="del" data-i="${i}">削除</button>
      </div>
    `;
    list.appendChild(div);
  });
}

list.onclick = (e) => {
  const btn = e.target;
  if (!btn.dataset.act) return;

  const i = Number(btn.dataset.i);

  if (btn.dataset.act === "del") {
    images.splice(i, 1);
  }
  if (btn.dataset.act === "up" && i > 0) {
    [images[i], images[i - 1]] = [images[i - 1], images[i]];
  }
  if (btn.dataset.act === "down" && i < images.length - 1) {
    [images[i], images[i + 1]] = [images[i + 1], images[i]];
  }

  renderList();
};

generateBtn.onclick = async () => {
  const cols = Number(colsInput.value);
  const rows = Math.ceil(images.length / cols);

  canvas.width = cols * (SIZE + GAP) - GAP;
  canvas.height = rows * (SIZE + GAP) - GAP;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (let i = 0; i < images.length; i++) {
    const img = new Image();
    img.src = images[i].url;
    await img.decode();

    const x = (i % cols) * (SIZE + GAP);
    const y = Math.floor(i / cols) * (SIZE + GAP);
    ctx.drawImage(img, x, y, SIZE, SIZE);
  }
};
</script>

</body>
</html>

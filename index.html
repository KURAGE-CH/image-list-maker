<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画像一覧メーカー（横枚数指定）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: sans-serif; padding: 20px; }
    .controls { margin-bottom: 20px; }

    #error {
      color: red;
      margin-top: 10px;
      display: none;
    }

    #image-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, 150px);
      gap: 10px;
    }

    .item {
      border: 1px solid #ccc;
      padding: 6px;
      background: #f9f9f9;
    }

    .drag-handle {
      cursor: grab;
      text-align: center;
      background: #e0e0e0;
      margin-bottom: 4px;
      user-select: none;
    }

    .item img {
      width: 100%;
      height: auto;
      display: block;
      margin-bottom: 4px;
    }

    canvas {
      margin-top: 30px;
      border: 1px solid #ccc;
      max-width: 100%;
    }
  </style>
</head>
<body>

<h1>画像一覧メーカー（横枚数指定）</h1>

<div class="controls">
  <input type="file" id="files" multiple accept="image/*"><br><br>

  キャンバス幅：
  <input type="number" id="cw" value="2480"> px

  横に並べる枚数：
  <input type="number" id="cols" value="3" min="1">

  間隔：
  <input type="number" id="gap" value="10" min="0"> px

  <br><br>
  <button id="generate">一覧画像を生成</button>
  <button id="download">PNG保存</button>

  <div id="error"></div>
</div>

<div id="image-list"></div>
<canvas id="canvas"></canvas>

<script>
const filesInput = document.getElementById("files");
const list = document.getElementById("image-list");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const cwInput = document.getElementById("cw");
const colsInput = document.getElementById("cols");
const gapInput = document.getElementById("gap");
const errorBox = document.getElementById("error");

const generateBtn = document.getElementById("generate");
const downloadBtn = document.getElementById("download");

const MIN_HEIGHT = 80;
const MAX_HEIGHT = 800;

let images = [];
let dragIndex = null;

/* === 画像追加 === */
filesInput.onchange = () => {
  for (const file of filesInput.files) {
    images.push({
      url: URL.createObjectURL(file),
      visible: true,
      count: 1
    });
  }
  renderList();
  filesInput.value = "";
};

/* === 編集一覧 === */
function renderList() {
  list.innerHTML = "";
  images.forEach((img, i) => {
    const div = document.createElement("div");
    div.className = "item";
    div.dataset.i = i;

    div.innerHTML = `
      <div class="drag-handle">⇅</div>
      <img src="${img.url}">
      枚数：
      <input type="number" min="1" value="${img.count}" data-i="${i}">
      <br>
      <button data-act="del" data-i="${i}">削除</button>
    `;

    const handle = div.querySelector(".drag-handle");
    handle.draggable = true;
    handle.addEventListener("dragstart", () => dragIndex = i);

    list.appendChild(div);
  });
}

/* === 並び替え === */
list.ondragover = (e) => {
  e.preventDefault();
  const item = e.target.closest(".item");
  if (!item) return;

  const target = Number(item.dataset.i);
  if (dragIndex === target) return;

  const moved = images.splice(dragIndex, 1)[0];
  images.splice(target, 0, moved);
  dragIndex = target;
  renderList();
};

/* === 生成処理 === */
generateBtn.onclick = async () => {
  errorBox.style.display = "none";

  const CW = Number(cwInput.value);
  const COLS = Number(colsInput.value);
  const GAP = Number(gapInput.value);

  const expanded = [];
  images.forEach(img => {
    for (let i = 0; i < img.count; i++) expanded.push(img.url);
  });

  canvas.width = CW;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  let y = 0;

  for (let i = 0; i < expanded.length; i += COLS) {
    const rowUrls = expanded.slice(i, i + COLS);
    const rowImgs = [];

    for (const url of rowUrls) {
      const img = new Image();
      img.src = url;
      await img.decode();
      rowImgs.push(img);
    }

    const totalAspect = rowImgs.reduce(
      (sum, img) => sum + img.width / img.height, 0
    );

    const rowHeight =
      (CW - GAP * (rowImgs.length - 1)) / totalAspect;

    if (
      rowHeight <= 0 ||
      rowHeight < MIN_HEIGHT ||
      rowHeight > MAX_HEIGHT
    ) {
      errorBox.textContent =
        "この設定では画像を配置できません（横枚数・間隔・幅を調整してください）";
      errorBox.style.display = "block";
      return;
    }

    let x = 0;
    rowImgs.forEach(img => {
      const w = rowHeight * (img.width / img.height);
      ctx.drawImage(img, x, y, w, rowHeight);
      x += w + GAP;
    });

    y += rowHeight + GAP;
  }

  canvas.height = y - GAP;
};

/* === PNG保存 === */
downloadBtn.onclick = () => {
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/png");
  a.download = "image-list.png";
  a.click();
};
</script>

</body>
</html>

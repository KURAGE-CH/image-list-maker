<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画像一覧メーカー（自動詰め）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    .controls {
      margin-bottom: 20px;
    }

    #image-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, 150px);
      gap: 10px;
    }

    .item {
      border: 1px solid #ccc;
      padding: 6px;
      background: #f9f9f9;
    }

    .item.hidden {
      opacity: 0.4;
    }

    .drag-handle {
      cursor: grab;
      text-align: center;
      background: #e0e0e0;
      margin-bottom: 4px;
      user-select: none;
    }

    .item img {
      width: 100%;
      height: auto;
      display: block;
      margin-bottom: 4px;
    }

    canvas {
      margin-top: 30px;
      border: 1px solid #ccc;
      max-width: 100%;
    }
  </style>
</head>
<body>

<h1>画像一覧メーカー（自動詰め配置）</h1>

<div class="controls">
  <input type="file" id="files" multiple accept="image/*"><br><br>

  キャンバスサイズ：
  <select id="preset">
    <option value="">手動</option>
    <option value="a4p">A4 縦</option>
    <option value="a4l">A4 横</option>
    <option value="b5p">B5 縦</option>
    <option value="b5l">B5 横</option>
    <option value="phone">スマホ（9:16）</option>
  </select>

  幅：
  <input type="number" id="cw" value="2480"> px
  高さ：
  <input type="number" id="ch" value="3508"> px

  <br><br>
  行間・画像間隔：
  <input type="number" id="gap" value="10" min="0"> px

  <br><br>
  <button id="generate">一覧画像を生成</button>
  <button id="download">PNG保存</button>
</div>

<div id="image-list"></div>
<canvas id="canvas"></canvas>

<script>
const filesInput = document.getElementById("files");
const list = document.getElementById("image-list");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const presetSelect = document.getElementById("preset");
const cwInput = document.getElementById("cw");
const chInput = document.getElementById("ch");
const gapInput = document.getElementById("gap");

const generateBtn = document.getElementById("generate");
const downloadBtn = document.getElementById("download");

let images = [];
let dragIndex = null;

/* === プリセット === */
presetSelect.onchange = () => {
  const presets = {
    a4p: [2480, 3508],
    a4l: [3508, 2480],
    b5p: [1760, 2480],
    b5l: [2480, 1760],
    phone: [1080, 1920]
  };
  const v = presetSelect.value;
  if (presets[v]) {
    cwInput.value = presets[v][0];
    chInput.value = presets[v][1];
  }
};

/* === 画像追加 === */
filesInput.onchange = () => {
  for (const file of filesInput.files) {
    images.push({
      url: URL.createObjectURL(file),
      visible: true,
      count: 1
    });
  }
  renderList();
  filesInput.value = "";
};

/* === 編集一覧 === */
function renderList() {
  list.innerHTML = "";
  images.forEach((img, i) => {
    const div = document.createElement("div");
    div.className = "item" + (img.visible ? "" : " hidden");
    div.dataset.i = i;

    div.innerHTML = `
      <div class="drag-handle">⇅</div>
      <img src="${img.url}">
      枚数：
      <input type="number" min="1" value="${img.count}" data-i="${i}">
      <br>
      <button data-act="toggle" data-i="${i}">
        ${img.visible ? "非表示" : "表示"}
      </button>
      <button data-act="del" data-i="${i}">削除</button>
    `;

    const handle = div.querySelector(".drag-handle");
    handle.draggable = true;

    handle.addEventListener("dragstart", () => {
      dragIndex = i;
    });

    list.appendChild(div);
  });
}

/* === 編集操作 === */
list.onchange = (e) => {
  if (e.target.type === "number") {
    const i = Number(e.target.dataset.i);
    images[i].count = Math.max(1, Number(e.target.value));
  }
};

list.onclick = (e) => {
  const act = e.target.dataset.act;
  if (!act) return;
  const i = Number(e.target.dataset.i);

  if (act === "del") images.splice(i, 1);
  if (act === "toggle") images[i].visible = !images[i].visible;
  renderList();
};

list.ondragover = (e) => {
  e.preventDefault();
  const item = e.target.closest(".item");
  if (!item) return;

  const target = Number(item.dataset.i);
  if (dragIndex === null || dragIndex === target) return;

  const moved = images.splice(dragIndex, 1)[0];
  images.splice(target, 0, moved);
  dragIndex = target;
  renderList();
};

/* === 自動詰めレイアウト生成 === */
generateBtn.onclick = async () => {
  const GAP = Number(gapInput.value);
  const CW = Number(cwInput.value);
  const CH = Number(chInput.value);

  canvas.width = CW;
  canvas.height = CH;
  ctx.clearRect(0, 0, CW, CH);

  const expanded = [];
  images.forEach(img => {
    if (!img.visible) return;
    for (let i = 0; i < img.count; i++) expanded.push(img.url);
  });

  let y = 0;
  let row = [];
  let rowAspect = 0;

  for (let i = 0; i < expanded.length; i++) {
    const image = new Image();
    image.src = expanded[i];
    await image.decode();

    const aspect = image.width / image.height;
    row.push(image);
    rowAspect += aspect;

    const rowHeight = (CW - GAP * (row.length - 1)) / rowAspect;

    if (y + rowHeight > CH) break;

    if (rowHeight < 300 || i === expanded.length - 1) {
      let x = 0;
      row.forEach(img => {
        const w = rowHeight * (img.width / img.height);
        ctx.drawImage(img, x, y, w, rowHeight);
        x += w + GAP;
      });
      y += rowHeight + GAP;
      row = [];
      rowAspect = 0;
    }
  }
};

/* === PNG保存 === */
downloadBtn.onclick = () => {
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/png");
  a.download = "image-list.png";
  a.click();
};
</script>

</body>
</html>

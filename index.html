<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画像一覧メーカー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: sans-serif; padding: 20px; }
    .controls { margin-bottom: 20px; }

    #image-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, 150px);
      gap: 10px;
    }

    .item {
      border: 1px solid #ccc;
      padding: 6px;
      background: #f9f9f9;
    }

    .item.hidden { opacity: 0.4; }

    .drag-handle {
      cursor: grab;
      text-align: center;
      font-size: 18px;
      background: #e0e0e0;
      margin-bottom: 4px;
      user-select: none;
    }

    .item.dragging { opacity: 0.4; }

    .item img {
      width: 100%;
      height: auto;
      display: block;
      margin-bottom: 4px;
    }

    canvas {
      margin-top: 30px;
      border: 1px solid #ccc;
      max-width: 100%;
    }
  </style>
</head>
<body>

<h1>画像一覧メーカー</h1>

<div class="controls">
  <input type="file" id="files" multiple accept="image/*"><br><br>

  横の枚数：
  <input type="number" id="cols" value="5" min="1">

  画像の間隔：
  <input type="number" id="gap" value="10" min="0">

  <br><br>
  <button id="generate">一覧画像を生成</button>
  <button id="download">PNG保存</button>
</div>

<div id="image-list"></div>
<canvas id="canvas"></canvas>

<script>
const filesInput = document.getElementById("files");
const list = document.getElementById("image-list");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const colsInput = document.getElementById("cols");
const gapInput = document.getElementById("gap");
const generateBtn = document.getElementById("generate");
const downloadBtn = document.getElementById("download");

const SIZE = 200;
let images = [];
let dragIndex = null;

/* === 画像追加 === */
filesInput.onchange = () => {
  for (const file of filesInput.files) {
    images.push({
      url: URL.createObjectURL(file),
      visible: true,
      count: 1
    });
  }
  renderList();
  filesInput.value = "";
};

/* === 一覧描画 === */
function renderList() {
  list.innerHTML = "";

  images.forEach((img, i) => {
    const div = document.createElement("div");
    div.className = "item" + (img.visible ? "" : " hidden");
    div.dataset.i = i;

    div.innerHTML = `
      <div class="drag-handle">⇅</div>
      <img src="${img.url}">
      枚数：
      <input type="number" min="1" value="${img.count}" data-act="count" data-i="${i}">
      <br>
      <button data-act="toggle" data-i="${i}">
        ${img.visible ? "非表示" : "表示"}
      </button>
      <button data-act="up" data-i="${i}">↑</button>
      <button data-act="down" data-i="${i}">↓</button>
      <button data-act="del" data-i="${i}">削除</button>
    `;

    const handle = div.querySelector(".drag-handle");
    handle.draggable = true;

    handle.addEventListener("dragstart", () => {
      dragIndex = i;
      div.classList.add("dragging");
    });

    handle.addEventListener("dragend", () => {
      div.classList.remove("dragging");
    });

    list.appendChild(div);
  });
}

/* === 枚数変更 === */
list.onchange = (e) => {
  if (e.target.dataset.act === "count") {
    const i = Number(e.target.dataset.i);
    images[i].count = Math.max(1, Number(e.target.value));
  }
};

/* === ボタン操作 === */
list.onclick = (e) => {
  const act = e.target.dataset.act;
  if (!act) return;
  const i = Number(e.target.dataset.i);

  if (act === "del") images.splice(i, 1);
  if (act === "toggle") images[i].visible = !images[i].visible;
  if (act === "up" && i > 0)
    [images[i], images[i - 1]] = [images[i - 1], images[i]];
  if (act === "down" && i < images.length - 1)
    [images[i], images[i + 1]] = [images[i + 1], images[i]];

  renderList();
};

/* === ドラッグ並び替え === */
list.addEventListener("dragover", (e) => {
  e.preventDefault();
  const item = e.target.closest(".item");
  if (!item) return;

  const targetIndex = Number(item.dataset.i);
  if (dragIndex === null || dragIndex === targetIndex) return;

  const moved = images.splice(dragIndex, 1)[0];
  images.splice(targetIndex, 0, moved);
  dragIndex = targetIndex;
  renderList();
});

/* === 一覧画像生成（比率保持） === */
generateBtn.onclick = async () => {
  const cols = Number(colsInput.value);
  const GAP = Number(gapInput.value);

  const output = [];
  images.forEach(img => {
    if (!img.visible) return;
    for (let i = 0; i < img.count; i++) output.push(img.url);
  });

  const rows = Math.ceil(output.length / cols);
  canvas.width = cols * (SIZE + GAP) - GAP;
  canvas.height = rows * (SIZE + GAP) - GAP;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (let i = 0; i < output.length; i++) {
    const image = new Image();
    image.src = output[i];
    await image.decode();

    const scale = Math.min(SIZE / image.width, SIZE / image.height);
    const w = image.width * scale;
    const h = image.height * scale;

    const x = (i % cols) * (SIZE + GAP) + (SIZE - w) / 2;
    const y = Math.floor(i / cols) * (SIZE + GAP) + (SIZE - h) / 2;

    ctx.drawImage(image, x, y, w, h);
  }
};

/* === PNG保存 === */
downloadBtn.onclick = () => {
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/png");
  a.download = "image-list.png";
  a.click();
};
</script>

</body>
</html>
